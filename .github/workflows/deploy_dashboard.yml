name: Deploy Dashboard

on:
  schedule:
    - cron: '45 * * * *'  # every hour at :45
  workflow_dispatch:

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      actions: read
      contents: read

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install GitHub CLI
      run: sudo apt-get install -y gh

    - name: Authenticate GH CLI
      run: gh auth setup-git
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Find latest successful training run ID
      id: get_run_id
      run: |
        latest_run_id=$(gh run list \
          --workflow "Model Training" \
          --branch main \
          --status success \
          --limit 1 \
          --json databaseId \
          -q '.[0].databaseId')
        echo "Latest training run ID: $latest_run_id"
        echo "run_id=$latest_run_id" >> $GITHUB_OUTPUT

    - name: Download model artifact from latest training run
      run: |
        gh run download ${{ steps.get_run_id.outputs.run_id }} \
          --name aqi-model \
          --dir models
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dashboard dependencies
      run: |
        pip install --upgrade pip
        pip install pandas xgboost scikit-learn joblib dash plotly dash-bootstrap-components

    - name: Run dashboard script
      run: python scripts/dashboard.py
